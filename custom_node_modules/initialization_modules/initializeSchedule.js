const config_helper = require('../utility_modules/config_helper')
const dbcalls = require('../utility_modules/database_calls')
const sLogger = require('../event_modules/sensorLogger')
const utils = require('../utility_modules/utils')
const html_generators = require('../utility_modules/html_generators')
const tEventHandler = require('../event_modules/event_handlers/timeEventHandler')
const sEventHandler = require('../event_modules/event_handlers/sensorEventHandler')
const pEventHandler = require('../event_modules/event_handlers/periodicEventHandler')
const cEventHandler = require('../event_modules/event_handlers/cameraEventHandler')
const { simpleErrorPrintout } = require('../utility_modules/printouts')

const config = config_helper.getConfig()
const LOGGING_TIMER = config.log_interval
const CAMERA_TIMER = config.camera.interval
const EVENT_TIMER = 1 * 1000 // 1 SECOND

/**
 * Initializes the schedule (time/sensor/periodic/minder), logging, and
 * establishes chart regeneration.
 * @param {object} state the current state
 */
async function initializeSchedule(state) {
  //Take initial reading to update database
  //Run events when ready, then set Interval.
  state.events = await dbcalls.getEnabledEvents()
  await sLogger.addSensorReadings(state)
  state.sensorState.writeSensorIndexDataToFile()
  await html_generators.regenerateChartData(LOGGING_TIMER);
  await tEventHandler.timeEventHandler(state);
  await sEventHandler.sensorEventHandler(state);
  await pEventHandler.periodicEventHandler(state);
  // Handle camera things, if enabled.
  initializeCamera()
  // Set up future events
  setInterval(async function() {
    await sLogger.addSensorReadings(state)
    state.sensorState.writeSensorIndexDataToFile()
    await html_generators.regenerateChartData(LOGGING_TIMER);
  }, LOGGING_TIMER);
  setInterval(async function() {
    await utils.scheduleMinder(state)
    await tEventHandler.timeEventHandler(state);
    await sEventHandler.sensorEventHandler(state);
    await pEventHandler.periodicEventHandler(state);
  }, EVENT_TIMER);
}
module.exports.initializeSchedule = initializeSchedule

/**
 * abstracted logic for camera pieces
 */
const initializeCamera = function() {
  if (config.camera.enable){
    try {
      cEventHandler.takeImageBetween()
    } catch (e) {
      simpleErrorPrintout(e)
    } 
    setInterval(() => {
      try {
        cEventHandler.takeImageBetween()
      } catch (e) {
        simpleErrorPrintout(e)
      }
    }, CAMERA_TIMER)
  }
}