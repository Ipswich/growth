var mysql = require('mysql');
var moment = require('moment');
var mappings = require('./Mappings.js')
var outputState = require('./OutputState.js')
var eventTriggers = require('./EventTriggers.js')

//Runs time events based on current time
module.exports.TimeEventHandler = async function TimeEventHandler(state) {
  const events = await eventTriggers.getEvents();
  const schedule = await eventTriggers.getSchedule('Time');
  //Error on things
  if (events == undefined || schedule == undefined) {
    console.error("TimeEventHandler.js: TimeEventHandler() failed!");
  } else {
    //If no errors, get current timestamp
    const currentTime = moment().format('HH:mm:ss');
    //Iterate through time Schedules
    for(let i = 0; i < schedule.length; i++){
      var triggerTime = moment(schedule[i].eventTriggerTime, "HH:mm:ss");
      //If trigger time matches time stamp, trigger event.
      if(moment(currentTime, "HH:mm:ss").isSame(triggerTime, 'minute')) {
        eventTriggers.triggerEvent(schedule[i], state);
      }
    }
  }
}
