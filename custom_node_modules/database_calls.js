var mysql = require('mysql');
var config = require('../config/config.json');

// Create connection pool
var pool = mysql.createPool(config.database)
// Check connection
pool.query('SELECT 1 + 1 AS solution', function (error, results, fields) {
  if (error) throw error;
  console.log("Database successfully connected");
});


module.exports.addNewEvent = async function(name, description, enabled) {
  return new Promise((resolve, reject) => {
    query = 'CALL addNewEvent(' + name + ',' + description + ',' + enabled + ')'
    pool.query(query, (error, results, fields) => {
      //Error on problem
      if(error) {
        console.error("addNewEvent() failed, database error.");
        reject(error);
      } else {
        resolve(results[0])
      }
    })
  })
}

module.exports.addNewOutput = async function(type, name, description) {
  return new Promise((resolve, reject) => {
    query = 'CALL addNewOutput(' + type + ',' + name + ',' + description + ')'
    pool.query(query, (error, results, fields) => {
      //Error on problem
      if(error) {
        console.error("addNewOutput() failed, database error.");
        reject(error);
      } else {
        resolve(results[0])
      }
    })
  })
}

module.exports.addNewOutputType = async function(type, enabled) {
  return new Promise((resolve, reject) => {
    query = 'CALL addNewOutputType(' + type + ',' + enabled + ')'
    pool.query(query, (error, results, fields) => {
      //Error on problem
      if(error) {
        console.error("addNewOutputType() failed, database error.");
        reject(error);
      } else {
        resolve(results[0])
      }
    })
  })
}

module.exports.addNewSchedule = async function(scheduleType, eventID, sensorID, sensorValue, outputID, outputValue, scheduleComparator, eventTriggerTime, scheduleStartDate, scheduleStopDate, enabled, addedBy, disabledBy) {
  return new Promise((resolve, reject) => {
    query = 'CALL addNewSchedule(' + scheduleType + ',' + eventID + ',' + sensorID + ',' + sensorValue + ',' + outputID + ',' + outputValue + ',' + scheduleComparator + ',' + eventTriggerTime + ',' + scheduleStartDate + ',' + scheduleStopDate + ',' + enabled + ',' + addedBy + ',' + disabledBy + ')'
    pool.query(query, (error, results, fields) => {
      //Error on problem
      if(error) {
        console.error("addNewSchedule() failed, database error.");
        reject(error);
      } else {
        resolve(results[0])
      }
    })
  })
}

module.exports.addNewScheduleType = async function(type, enabled) {
  return new Promise((resolve, reject) => {
    query = 'CALL addNewScheduleType(' + type + ',' + enabled + ')'
    pool.query(query, (error, results, fields) => {
      //Error on problem
      if(error) {
        console.error("addNewScheduleType() failed, database error.");
        reject(error);
      } else {
        resolve(results[0])
      }
    })
  })
}

module.exports.addNewSensor = async function(model, type, location, units, hardwareID, sensorProtocol) {
  return new Promise((resolve, reject) => {
    query = 'CALL addNewSensor(' + model + ',' + type + ',' + location + ',' + units + ',' + hardwareID + ',' + sensorProtocol + ')'
    pool.query(query, (error, results, fields) => {
      //Error on problem
      if(error) {
        console.error("addNewSensor() failed, database error.");
        reject(error);
      } else {
        resolve(results[0])
      }
    })
  })
}

module.exports.addNewSensorType = async function(type, enabled) {
  return new Promise((resolve, reject) => {
    query = 'CALL addNewSensorType(' + type + ',' + enabled + ')'
    pool.query(query, (error, results, fields) => {
      //Error on problem
      if(error) {
        console.error("addNewSensorType() failed, database error.");
        reject(error);
      } else {
        resolve(results[0])
      }
    })
  })
}

module.exports.addNewUser = async function(username, hash) {
  return new Promise((resolve, reject) => {
    query = 'CALL addNewUser(' + username + ',' + hash + ')'
    pool.query(query, (error, results, fields) => {
      //Error on problem
      if(error) {
        console.error("addNewUser() failed, database error.");
        reject(error);
      } else {
        resolve(results[0])
      }
    })
  })
}

module.exports.addSensorReading = async function(sensorID, data) {
  return new Promise((resolve, reject) => {
    query = 'CALL addSensorReading(' + sensorID + ',' + data + ')'
    pool.query(query, (error, results, fields) => {
      //Error on problem
      if(error) {
        console.error("addSensorReading() failed, database error.");
        reject(error);
      } else {
        resolve(results[0])
      }
    })
  })
}

module.exports.disableSchedule = async function(id, user) {
  return new Promise((resolve, reject) => {
    query = 'CALL disableSchedule(' + id + ',' + user + ')'
    pool.query(query, (error, results, fields) => {
      //Error on problem
      if(error) {
        console.error("disableSchedule() failed, database error.");
        reject(error);
      } else {
        resolve(results[0])
      }
    })
  })
}

module.exports.getAllEvents = async function() {
  return new Promise((resolve, reject) => {
    query = 'CALL getAllEvents()'
    pool.query(query, (error, results, fields) => {
      //Error on problem
      if(error) {
        console.error("getAllEvents() failed, database error.");
        reject(error);
      } else {
        resolve(results[0])
      }
    })
  })
}

module.exports.getAllOutputs = async function() {
  return new Promise((resolve, reject) => {
    query = 'CALL getAllOutputs()'
    pool.query(query, (error, results, fields) => {
      //Error on problem
      if(error) {
        console.error("getAllOutputs() failed, database error.");
        reject(error);
      } else {
        resolve(results[0])
      }
    })
  })
}

module.exports.getAllOutputTypes = async function() {
  return new Promise((resolve, reject) => {
    query = 'CALL getAllOutputTypes()'
    pool.query(query, (error, results, fields) => {
      //Error on problem
      if(error) {
        console.error("getAllOutputTypes() failed, database error.");
        reject(error);
      } else {
        resolve(results[0])
      }
    })
  })
}

module.exports.getAllSchedules = async function() {
  return new Promise((resolve, reject) => {
    query = 'CALL getAllSchedules()'
    pool.query(query, (error, results, fields) => {
      //Error on problem
      if(error) {
        console.error("getAllSchedules() failed, database error.");
        reject(error);
      } else {
        resolve(results[0])
      }
    })
  })
}

module.exports.getAllScheduleTypes = async function() {
  return new Promise((resolve, reject) => {
    query = 'CALL getAllScheduleTypes()'
    pool.query(query, (error, results, fields) => {
      //Error on problem
      if(error) {
        console.error("getAllScheduleTypes() failed, database error.");
        reject(error);
      } else {
        resolve(results[0])
      }
    })
  })
}

module.exports.getAllSensors = async function() {
  return new Promise((resolve, reject) => {
    query = 'CALL getAllSensors()'
    pool.query(query, (error, results, fields) => {
      //Error on problem
      if(error) {
        console.error("getAllSensors() failed, database error.");
        reject(error);
      } else {
        resolve(results[0])
      }
    })
  })
}

module.exports.getAllSensorTypes = async function() {
  return new Promise((resolve, reject) => {
    query = 'CALL getAllSensorTypes()'
    pool.query(query, (error, results, fields) => {
      //Error on problem
      if(error) {
        console.error("getAllSensorTypes() failed, database error.");
        reject(error);
      } else {
        resolve(results[0])
      }
    })
  })
}

module.exports.getEnabledEvents = async function() {
  return new Promise((resolve, reject) => {
    query = 'CALL getEnabledEvents()'
    pool.query(query, (error, results, fields) => {
      //Error on problem
      if(error) {
        console.error("getEnabledEvents() failed, database error.");
        reject(error);
      } else {
        resolve(results[0])
      }
    })
  })
}

module.exports.getEnabledLiveSchedules = async function(){
  return new Promise((resolve, reject) => {    
    let query = 'CALL getEnabledLiveSchedules()'
    pool.query(query, (error, results, fields) => {
      //Error on problem
      if(error) {
        console.error("getEnabledLiveSchedules() failed, database error.");
        reject(error);
      } else {
        //(success)
        resolve(results[0])
      }
    })
  })
}

module.exports.getEnabledOutputs = async function() {
  return new Promise((resolve, reject) => {    
    let query = 'CALL getEnabledOutputs()'
    pool.query(query, (error, results, fields) => {
      //Error on problem
      if(error) {
        console.error("getEnabledOutputs() failed, database error.");
        reject(error);
      } else {
        //(success)
        resolve(results[0])
      }
    })
  })
}

module.exports.getEnabledOutputTypes = async function() {
  return new Promise((resolve, reject) => {    
    let query = 'CALL getEnabledOutputTypes()'
    pool.query(query, (error, results, fields) => {
      //Error on problem
      if(error) {
        console.error("getEnabledOutputTypes() failed, database error.");
        reject(error);
      } else {
        //(success)
        resolve(results[0])
      }
    })
  })
}

module.exports.getEnabledSchedules = async function() {
  return new Promise((resolve, reject) => {    
    let query = 'CALL getEnabledSchedules()'
    pool.query(query, (error, results, fields) => {
      //Error on problem
      if(error) {
        console.error("getEnabledSchedules() failed, database error.");
        reject(error);
      } else {
        //(success)
        resolve(results[0])
      }
    })
  })
}

module.exports.getEnabledScheduleTypes = async function() {
  return new Promise((resolve, reject) => {    
    let query = 'CALL getEnabledScheduleTypes()'
    pool.query(query, (error, results, fields) => {
      //Error on problem
      if(error) {
        console.error("getEnabledScheduleTypes() failed, database error.");
        reject(error);
      } else {
        //(success)
        resolve(results[0])
      }
    })
  })
}

module.exports.getEnabledSensors = async function() {
  return new Promise((resolve, reject) => {    
    let query = 'CALL getEnabledSensors()'
    pool.query(query, (error, results, fields) => {
      //Error on problem
      if(error) {
        console.error("getEnabledSensors() failed, database error.");
        reject(error);
      } else {
        //(success)
        resolve(results[0])
      }
    })
  })
}

module.exports.getEnabledSensorTypes = async function() {
  return new Promise((resolve, reject) => {    
    let query = 'CALL getEnabledSensorTypes()'
    pool.query(query, (error, results, fields) => {
      //Error on problem
      if(error) {
        console.error("getEnabledSensorTypes() failed, database error.");
        reject(error);
      } else {
        //(success)
        resolve(results[0])
      }
    })
  })
}

module.exports.getScheduleByID = async function(id) {
  return new Promise((resolve, reject) => {    
    let query = 'CALL getScheduleByID(' + id + ')'
    pool.query(query, (error, results, fields) => {
      //Error on problem
      if(error) {
        console.error("getScheduleByID() failed, database error.");
        reject(error);
      } else {
        //(success)
        resolve(results[0])
      }
    })
  })
}

module.exports.getSensorDataByType = async function(type) {
  return new Promise((resolve, reject) => {    
    let query = 'CALL getSensorDataByType(' + type + ')'
    pool.query(query, (error, results, fields) => {
      //Error on problem
      if(error) {
        console.error("getSensorDataByType() failed, database error.");
        reject(error);
      } else {
        //(success)
        resolve(results[0])
      }
    })
  })
}

module.exports.getSensorLastReadings = async function() {
  return new Promise((resolve, reject) => {    
    let query = 'CALL getSensorLastReadings()'
    pool.query(query, (error, results, fields) => {
      //Error on problem
      if(error) {
        console.error("getSensorLastReadings() failed, database error.");
        reject(error);
      } else {
        //(success)
        resolve(results[0])
      }
    })
  })
}

module.exports.getSensorLastReadingsByHours = async function(hours) {
  return new Promise((resolve, reject) => {    
    let query = 'CALL getSensorLastReadingsByHours(' + hours + ')'
    pool.query(query, (error, results, fields) => {
      //Error on problem
      if(error) {
        console.error("getSensorLastReadingsByHours() failed, database error.");
        reject(error);
      } else {
        //(success)
        resolve(results[0])
      }
    })
  })
}

module.exports.getUser = async function(username) {
  return new Promise((resolve, reject) => {    
    let query = 'CALL getUser(' + username + ')'
    pool.query(query, (error, results, fields) => {
      //Error on problem
      if(error) {
        console.error("getUser() failed, database error.");
        reject(error);
      } else {
        //(success)
        resolve(results[0])
      }
    })
  })
}

module.exports.logScheduledEvent = async function(scheduleID) {
  return new Promise((resolve, reject) => {    
    let query = 'CALL logScheduledEvent(' + scheduleID + ')'
    pool.query(query, (error, results, fields) => {
      //Error on problem
      if(error) {
        console.error("logScheduledEvent() failed, database error.");
        reject(error);
      } else {
        //(success)
        resolve(results[0])
      }
    })
  })
}

module.exports.updateSensorAddress = async function(address, sensorID){
  return new Promise(resolve => {
    let query = 'CALL updateSensorAddress(' + address + ', ' + sensorID + ')'
    pool.query(query, (error, results, fields) => {
      //Error on problem.
      if(error) {
        console.error("updateSensorAddress() failed, database error.");          
        reject(error);
      } else {
        resolve(results[0])
      }
    })
  })
}

