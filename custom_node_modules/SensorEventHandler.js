var mysql = require('mysql');
var moment = require('moment');
var mappings = require('./Mappings.js')
var outputState = require('./OutputState.js')
var eventTriggers = require('./EventTriggers.js')

//Runs sensor events based on last readings from DB
module.exports.SensorEventHandler = async function SensorEventHandler(outputState){
  const events = await eventTriggers.getEvents();
  const sensorReadings = await eventTriggers.getSensorReadings();
  const outputs = await mappings.getOutputMappings();
  const schedule = await eventTriggers.getSchedule('Sensor');
  if (events == undefined || outputs == undefined || schedule == undefined) {
    console.error("SensorEventHandler.js: SensorEventHandler() failed!");
  } else {
    //Iterate through schedules
    for(let i = 0; i < schedule.length; i++) {
      //Find the last sensor reading for the schedule's sensor
      for(let j = 0; j < sensorReadings.length; j++) {
        if(schedule[i].sensorID == sensorReadings[j].sensorID){
          var sensorVal = sensorReadings[j].data;
        }
      }
      //Switch based on schedule's comparator
      switch(schedule[i].scheduleComparator) {
      case '>':
        if(sensorVal > schedule[i].sensorValue) {
          eventTriggers.triggerEvent(schedule[i], outputs, outputState);
        }
        break;
      case '<':
        if(sensorVal < schedule[i].sensorValue) {
          eventTriggers.triggerEvent(schedule[i], outputs, outputState);
        }
        break;
      }
    }
  }
}
