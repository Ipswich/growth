const events = require('events')
const chai = require('chai')
const sinon = require('sinon')
const assert = chai.assert;
const five = require('johnny-five')
const config_helper = require('../../../../custom_node_modules/utility_modules/config_helper')
const mappings = require('../../../../custom_node_modules/utility_modules/mappings')
const initializeOutputs = require('../../../../custom_node_modules/initialization_modules/initializeOutputs')

describe('initializeOutputs.js tests', () => {  
  describe('initializeOutputs() tests', () => {
    it('should attach a relay control pin to state, update event listeners', () => {
      let test_state = {
        "outputState": {
          "data": []    
        },
        "sensorState": {
          "data": []
        }
      }
      let dummy_board = new events.EventEmitter()
      sinon.stub(five, 'Pin').returns({relay_control:1})
      sinon.stub(mappings, 'getBoardMapping').returns({OUTPUT_PINS: [1]})
      sinon.stub(config_helper, 'getConfig').returns({relay_toggle_prevention: true})
      initializeOutputs.initializeOutputs(test_state, dummy_board)
      assert.deepEqual(test_state.relay_control, {relay_control: 1})
      assert.equal(dummy_board.getMaxListeners(), 11)
    })

    it('should attach 3 outputs, 2 with PWM outputs with no relay control pin and update event listeners', () => {
      let test_state = {
        "outputState": {
          "data": [{
            outputPin: 2, 
            outputObject: undefined, 
            outputPWMPin: 3,
            outputPWMObject: undefined
          }, {
            outputPin: 4,
            outputObject: undefined
          }, {
            outputPin: 5,
            outputObject: undefined,
            outputPWMPin: 6,
            outputPWMObject: undefined
          }]    
        },
        "sensorState": {
          "data": []
        }
      }
      let dummy_board = new events.EventEmitter()
      sinon.stub(five, 'Led').returns({
        PWM:1,
        off: function(){}
      })
      sinon.stub(five, 'Relay').returns({
        Output:1,
        open: function(){}
      })
      sinon.stub(config_helper, 'getConfig').returns({relay_toggle_prevention: false})
      initializeOutputs.initializeOutputs(test_state, dummy_board)

      assert.typeOf(test_state.outputState.data[0].outputObject, 'object')
      assert.typeOf(test_state.outputState.data[0].outputPWMObject, 'object')
      assert.typeOf(test_state.outputState.data[1].outputObject, 'object')
      assert.typeOf(test_state.outputState.data[2].outputObject, 'object')
      assert.typeOf(test_state.outputState.data[2].outputPWMObject, 'object')
      assert.equal(dummy_board.getMaxListeners(), 16)
    })
    
    it('should run out of (output) pins and throw an error', () => {
      let test_state = {
        "outputState": {
          "data": [{
            outputPin: 2,
            outputObject: undefined
          }]    
        },
        "sensorState": {
          "data": []
        }
      }      
      let dummy_board = new events.EventEmitter()
      sinon.stub(config_helper, 'getConfig').returns({relay_toggle_prevention: false})
      sinon.stub(five, 'Relay').returns({
        Output:1,
        open: function(){throw new Error("Error!")}
      })
      assert.throws(() => {initializeOutputs.initializeOutputs(test_state, dummy_board)}, "Error!")
    })

    it('should run out of (PWM) pins and throw an error', () => {
      let test_state = {
        "outputState": {
          "data": [{
            outputPin: 2, 
            outputObject: undefined, 
            outputPWMPin: 3,
            outputPWMObject: undefined
          }]    
        },
        "sensorState": {
          "data": []
        }
      }
      let dummy_board = new events.EventEmitter()
      sinon.stub(config_helper, 'getConfig').returns({relay_toggle_prevention: false})
      sinon.stub(five, 'Relay').returns({
        Output:1,
        open: function(){}
      })
      sinon.stub(five, 'Led').returns({
        PWM:1,
        off: function(){throw new Error("Error!")}
      })
      assert.throws(() => {initializeOutputs.initializeOutputs(test_state, dummy_board)}, "Error!")
    })
  })
})